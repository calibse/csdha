#! /bin/sh
# run_serve

set -e

usage() {
	echo "Usage: $0 [-br]"
	echo
	exit 1
}

push_assets() {
	npm run build
	rsync -avz --delete resources/pdf/images/ $SSH_SERVER:csdha/resources/pdf/images/
	rsync -avz --delete resources/pdf/fonts/ $SSH_SERVER:csdha/resources/pdf/fonts/
	rsync -avz --delete public/build/ $SSH_SERVER:csdha/public/build/
	rsync -avz --delete public/icon/ $SSH_SERVER:csdha/public/icon/
	rsync -avz --delete public/font/ $SSH_SERVER:csdha/public/font/
	rsync -avz --delete public/images/ $SSH_SERVER:csdha/public/images/
	rsync -avz k8s/secret.yaml $SSH_SERVER:csdha/k8s/secret.yaml
	rsync -avz .env.production $SSH_SERVER:csdha/.env
	rsync -avz .env.production.admin $SSH_SERVER:csdha/.env.admin
}

ssh $SSH_SERVER 'cd csdha && git pull'

while getopts "b" opt; do
	case $opt in
		b) push_assets ;;
		*) usage ;;
	esac
done

ssh $SSH_SERVER 'cd csdha && ./serve'

